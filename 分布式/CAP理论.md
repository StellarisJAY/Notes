# CAP理论

系统中，一致性（Consistancy）、可用性（Availability）、分区容错性（Partition tolerance）三者不可兼得。

分布式系统中一致性和可用性无法完美相容。

- 一致性（Consistancy）：分布式系统中所有节点的数据是一致的。
- 可用性（Availability）：保证每个请求无论是否出错都能即时回复
- 分区容错性（Partition tolerance）：分布式系统中的部分节点故障时，系统能够稳定运行

## 一致性

从客户端和服务端两个角度来看一致性，客户端的一致性是指每个用户都能看到最新的数据，服务端的一致性是指数据更新操作最终分布到所有节点，使所有节点数据一致。

一致性可以分为强、弱、最终三种

1. **强一致性**：单节点的关系型数据库，更新后的数据能够马上被看到。传统的ACID理论就具有强一致性。
2. **弱一致性**：能容忍后续的部分或者全部访问不到，则是弱一致性。
3. **最终一致性**：经过一段时间后要求能访问到更新后的数据，则是最终一致性。比如对异步主从复制，客户端写入主节点后，主节点会直接返回结果，然后异步完成数据同步。

## 可用性

可用性用来衡量用户的体验，保证客户的每一个请求都能即时得到响应，不会出现操作错误、超时等影响用户体验的响应。

## 分区容错性

分区容错性指系统中一个节点或网络分区故障下线时，系统仍然能够提供对外的服务



## CAP的取舍

### CA舍P

为了保证一致性和高可用性而放弃分布式结构，转为单机结构。一旦单机节点故障就会使整个系统下线。ACID理论就是通过牺牲分区容错性来达到强一致性和高可用性。

### CP舍A

保证一致性和分区容错。这使每次请求只有所有节点都同步成功才会返回成功，会降低系统的响应速度即可用性。不过如果能够在故障时进行服务降级和即时的错误响应，也做到了**基本可用**（Basically Available）

### AP舍C

大多数系统都只做到了AP，即保证高可用和分区容错而舍弃了一致性。AP下对更新请求会立即返回成功响应，此时因为网络等因素系统的数据是短暂不一致的。如果能够在后面完成同步，还是能够达到**最终一致性**（Eventually Consistant）



## BASE理论

基本可用（Basically Available）、软状态（Soft State）、最终一致（Eventually Consistant）。

BASE理论通过牺牲强一致性转为最终一致性，来保证系统的可用性。

### 基本可用

系统虽然出现故障但是仍然能够使用

1. 降低响应速度：无故障时可能响应速度很快，故障时降低响应速度标准
2. 服务降级：突发峰值请求时，将部分请求的服务降级。比如电商秒杀场景，将部分用户转到降级页面

### 软状态

硬状态对应了原子性，即多个节点的副本总是一致的。

而软状态，允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。

### 最终一致

系统中的数据可能出现短暂的不一致，不过经过同步后能够达到最终一致