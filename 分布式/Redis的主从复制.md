# Redis主从复制

Master负责读写、slave只读。

网络正常时，主节点会不断同步数据到从节点

![1](C:\Users\76040\Desktop\1.png)

## 特点

**优点**：提高了读效率

**缺点**：Master节点一旦挂掉，整个集群就失去了写能力



## 哨兵模式

用来解决主节点挂掉导致整个集群失去写能力的问题

哨兵负责监控集群中master和slave的状态，当监控到Master出现故障时，哨兵网络会进行选举，从Slave中选举出新的Master。

多个哨兵会组成哨兵网络，它们之间通过网络分享监控信息。

![3](C:\Users\76040\Desktop\3.png)

## 监控

Sentinel会不断监控主从服务器的状态

## 提醒

当监控发现某个服务器出现故障时，会通过API向应用程序发送通知

## 故障切换

当Master出现故障时，Sentinel会进行选举，将一个Slave服务器选举成新的Master。之所以Slave能够作为Master，是因为前一个Master存活时将数据备份到了Slave中。

### 故障切换过程

- **投票**：当任意一个Sentinel发现Master故障后，会通知其他Sentinel开会，投票决定是否让故障Master下线
- **选举**：确定Master下线后，Sentinel从所有Slave中选举新的Master
- **原Master恢复**：原有Master恢复后，会以Slave身份加入集群

![img](https://img2018.cnblogs.com/blog/1449477/201901/1449477-20190117081557550-451529206.png)

### 哨兵模式的CAP？

CA：哨兵模式具有高可用性和一致性



## Cluster模式

数据分片后的主从模式，数据按照一定的分区规则进入不同的集群中，每个集群按主从模式划分。

![img](https://img2018.cnblogs.com/blog/774371/201907/774371-20190704142443495-657525295.png)

### 一致性Hash分区



![深入剖析Redis系列： Redis集群模式搭建与原理详解](http://p3.pstatp.com/large/pgc-image/c7ba7be44f5746cea6aa5f61b43f9028)

节点按照顺时针在一个0~2^32范围排列。

一个key进来后计算Hash值，然后找到Hash值顺时针方向最近的节点。

一个新的节点加入时，在顺时针最后一个节点后加入。

**优点**：加入和删除节点只会影响顺时针方向的key

**缺点**：加减节点会使部分key无法命中，如果节点数量很少，会导致一个节点的范围很大，如果加减节点会导致大量key失效。

**总结**：一致性Hash算法不适合少量节点的分布式集群



## 虚拟槽分区

Redis Cluster槽范围为0~16383，共 2^14个槽

![img](https://img2018.cnblogs.com/blog/1449477/201901/1449477-20190117082348428-1446271590.png)

添加节点时就要将其他节点的槽分一部分给新节点

删除节点时要将该节点的槽分给其他节点

从一个节点将槽位移动到另一个节点并不会使节点暂停服务